# Документ требований

## Введение

Данный документ описывает требования к модульной архитектуре управления ботом YOTTO-JS. Личный кабинет на сайте dev.ioperator.ai позволит клиентам:
- Подключать различные CRM-системы (Bitrix24, AmoCRM, HubSpot и др.)
- Подключать различные каналы связи (Telegram, WhatsApp, Viber, VK и др.)
- Редактировать промты, которые использует AI-бот YOTTO-JS

Архитектура предполагает разделение:
- **dev.ioperator.ai** - личный кабинет (Dashboard) для управления настройками
- **YOTTO-JS-bot** (https://github.com/st-VALVe/YOTTO-JS-bot) - отдельный проект бота, который получает конфигурацию из Dashboard

## Глоссарий

- **Dashboard**: Личный кабинет клиента на dev.ioperator.ai для управления настройками бота YOTTO-JS
- **YOTTO_JS_Bot**: Внешний проект бота (https://github.com/st-VALVe/YOTTO-JS-bot), который использует конфигурацию из Dashboard
- **CRM_Integration**: Модуль интеграции с внешней CRM-системой для синхронизации данных о клиентах и заказах
- **Channel_Connector**: Модуль подключения канала связи (мессенджера) для приёма и отправки сообщений
- **Prompt_Template**: Шаблон промта, используемый YOTTO_JS_Bot для генерации ответов через OpenAI (gpt-5.2)
- **Integration_Registry**: Реестр доступных интеграций с метаданными и конфигурацией
- **Business_Profile**: Профиль бизнеса клиента, к которому привязаны интеграции
- **Webhook**: HTTP-эндпоинт для получения событий от внешних сервисов
- **Config_API**: API для получения конфигурации бота из Dashboard

## Требования

### Требование 1: Управление CRM-интеграциями

**User Story:** Как клиент, я хочу подключать различные CRM-системы к своему боту, чтобы автоматически синхронизировать данные о клиентах и заказах.

#### Критерии приёмки

1. WHEN клиент открывает страницу интеграций THEN Dashboard SHALL отображать список доступных CRM-систем (Bitrix24, AmoCRM, HubSpot, Salesforce)
2. WHEN клиент выбирает CRM для подключения THEN Dashboard SHALL отображать форму с необходимыми полями для авторизации (API-ключ, webhook URL, токен)
3. WHEN клиент вводит корректные данные авторизации THEN CRM_Integration SHALL проверить подключение и сохранить конфигурацию
4. IF клиент вводит некорректные данные авторизации THEN CRM_Integration SHALL отобразить понятное сообщение об ошибке
5. WHEN CRM успешно подключена THEN Dashboard SHALL отображать статус подключения и дату последней синхронизации
6. WHEN клиент отключает CRM THEN CRM_Integration SHALL удалить конфигурацию и прекратить синхронизацию
7. THE CRM_Integration SHALL поддерживать хранение учётных данных в зашифрованном виде

### Требование 2: Управление каналами связи

**User Story:** Как клиент, я хочу подключать различные мессенджеры к своему боту, чтобы общаться с клиентами через удобные им каналы.

#### Критерии приёмки

1. WHEN клиент открывает страницу каналов THEN Dashboard SHALL отображать список доступных каналов (Telegram, WhatsApp, Viber, VK, веб-виджет)
2. WHEN клиент выбирает Telegram для подключения THEN Dashboard SHALL отображать инструкцию по созданию бота и поле для ввода токена
3. WHEN клиент вводит корректный токен Telegram-бота THEN Channel_Connector SHALL проверить токен и активировать канал
4. WHEN клиент выбирает WhatsApp для подключения THEN Dashboard SHALL отображать форму для настройки WhatsApp Business API
5. WHEN канал успешно подключен THEN Dashboard SHALL отображать статус канала (активен/неактивен) и статистику сообщений
6. WHEN клиент отключает канал THEN Channel_Connector SHALL прекратить приём сообщений из этого канала
7. WHILE канал активен THE Channel_Connector SHALL предоставлять конфигурацию канала для YOTTO_JS_Bot через Config_API
8. IF канал становится недоступен THEN Channel_Connector SHALL уведомить клиента через Dashboard и email

### Требование 3: Редактор промтов

**User Story:** Как клиент, я хочу редактировать промты, которые использует мой бот, чтобы настроить его поведение и стиль общения под свой бизнес.

#### Критерии приёмки

1. WHEN клиент открывает редактор промтов THEN Dashboard SHALL отображать текущий системный промт бота
2. WHEN клиент редактирует промт THEN Dashboard SHALL предоставлять текстовый редактор с подсветкой переменных
3. WHEN клиент сохраняет промт THEN Prompt_Template SHALL валидировать промт на наличие обязательных секций
4. IF промт содержит синтаксические ошибки THEN Prompt_Template SHALL отобразить описание ошибки
5. WHEN клиент сохраняет валидный промт THEN YOTTO_JS_Bot SHALL использовать новый промт для последующих ответов (через Config_API)
6. THE Dashboard SHALL предоставлять возможность тестирования промта в песочнице перед применением
7. THE Prompt_Template SHALL поддерживать переменные для динамической подстановки данных бизнеса (название, меню, контакты)
8. WHEN клиент хочет вернуться к предыдущей версии THEN Prompt_Template SHALL хранить историю изменений промтов

### Требование 4: Реестр интеграций

**User Story:** Как система, я должна хранить и управлять конфигурациями всех интеграций, чтобы обеспечить их корректную работу.

#### Критерии приёмки

1. THE Integration_Registry SHALL хранить метаданные каждой интеграции (тип, название, иконка, описание, обязательные поля)
2. THE Integration_Registry SHALL хранить конфигурацию подключенных интеграций для каждого Business_Profile
3. WHEN новая интеграция добавляется в систему THEN Integration_Registry SHALL позволять расширение без изменения кода Dashboard
4. THE Integration_Registry SHALL предоставлять API для получения списка доступных и подключенных интеграций
5. WHEN конфигурация интеграции изменяется THEN Integration_Registry SHALL сохранять изменения в базу данных

### Требование 5: Config API для YOTTO-JS бота

**User Story:** Как YOTTO_JS_Bot, я должен получать актуальную конфигурацию из Dashboard, чтобы использовать настройки клиента.

#### Критерии приёмки

1. THE Config_API SHALL предоставлять эндпоинт для получения конфигурации бота по API-ключу
2. WHEN YOTTO_JS_Bot запрашивает конфигурацию THEN Config_API SHALL возвращать активные каналы, промты и настройки CRM
3. WHEN конфигурация изменяется в Dashboard THEN Config_API SHALL возвращать обновлённые данные при следующем запросе
4. THE Config_API SHALL поддерживать webhook для уведомления YOTTO_JS_Bot об изменениях конфигурации
5. WHEN API-ключ невалиден THEN Config_API SHALL возвращать ошибку 401 Unauthorized
6. THE Config_API SHALL кэшировать конфигурацию для снижения нагрузки на базу данных

### Требование 6: Обработка событий от интеграций

**User Story:** Как система, я должна обрабатывать входящие события от CRM и каналов связи, чтобы обеспечить двустороннюю синхронизацию.

#### Критерии приёмки

1. WHEN CRM отправляет webhook-событие THEN Dashboard SHALL обработать событие и обновить локальные данные
2. WHEN пользователь отправляет сообщение через канал THEN YOTTO_JS_Bot SHALL использовать конфигурацию из Dashboard
3. WHEN происходит ошибка обработки события THEN система SHALL логировать ошибку и повторить попытку
4. THE система SHALL обеспечивать идемпотентность обработки событий для предотвращения дублирования

### Требование 7: Безопасность и авторизация

**User Story:** Как клиент, я хочу быть уверен, что мои данные интеграций защищены и доступны только мне.

#### Критерии приёмки

1. THE система SHALL шифровать все API-ключи и токены интеграций при хранении в базе данных
2. WHEN клиент запрашивает данные интеграций THEN система SHALL возвращать только интеграции, принадлежащие его Business_Profile
3. THE система SHALL валидировать webhook-запросы от внешних сервисов по подписи или токену
4. WHEN клиент удаляет аккаунт THEN система SHALL удалить все связанные интеграции и их конфигурации
5. THE Dashboard SHALL требовать повторную аутентификацию для изменения критичных настроек интеграций

### Требование 8: UI Dashboard для управления интеграциями

**User Story:** Как клиент, я хочу иметь удобный интерфейс для управления всеми интеграциями в одном месте.

#### Критерии приёмки

1. THE Dashboard SHALL отображать сводную страницу со статусом всех подключенных интеграций
2. WHEN интеграция требует внимания (ошибка, истёк токен) THEN Dashboard SHALL отображать предупреждение
3. THE Dashboard SHALL группировать интеграции по типу (CRM, каналы связи, промты)
4. WHEN клиент нажимает на интеграцию THEN Dashboard SHALL открывать детальную страницу настроек
5. THE Dashboard SHALL быть адаптивным и работать на мобильных устройствах
6. THE Dashboard SHALL отображать логи последних событий для каждой интеграции
